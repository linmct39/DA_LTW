name: Auto Deploy to VPS

# Kích hoạt khi có code đẩy lên nhánh main
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Server via SSH
      # Sử dụng tool có sẵn để SSH vào server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        port: 22
        # Đoạn script này sẽ chạy trên Server của bạn
        script: |
          # 1. Đi vào thư mục dự án (Thay đổi đường dẫn này cho đúng với server của bạn)
          cd /var/www/DA_LTW 
          
          # 2. Lấy code mới nhất từ GitHub về
          git pull origin main
          
          # 3. Dựng lại Docker (Chỉ build lại những gì thay đổi)
          # Lưu ý: Không dùng down -v để tránh mất dữ liệu DB
          docker-compose up -d --build
          
          # 4. Xóa bớt rác (image cũ) cho sạch server
          docker image prune -f